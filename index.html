<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mantra's Tomorrow.io Weather App</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #eef2f3; color: #333; }
  header { background: #0077cc; color: white; padding: 1rem; text-align: center; }
  main { max-width: 900px; margin: 1rem auto; padding: 0 1rem; }
  .section { background: white; padding: 1rem; margin-bottom: 1rem; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  h2 { margin-top: 0; }
  #map { height: 300px; border-radius: 6px; }
  .forecast-day { display: inline-block; width: 28%; margin-right: 3%; text-align: center; }
  .forecast-day:last-child { margin-right: 0; }
  .alert { background: #ffdddd; border-left: 6px solid #f44336; padding: 10px; margin-bottom: 1rem; border-radius: 4px; }
</style>
<!-- Leaflet CSS & JS for map -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
<header>
  <h1>Mantra's Tomorrow.io Weather App</h1>
</header>
<main>
  <section class="section" id="alerts-section"></section>

  <section class="section" id="current-weather">
    <h2>Current Weather</h2>
    <div id="current-data">Loading...</div>
  </section>

  <section class="section" id="rain-forecast">
    <h2>Minute-by-Minute Rain Forecast (Next Hour)</h2>
    <div id="rain-data">Loading...</div>
  </section>

  <section class="section" id="three-day-forecast">
    <h2>3-Day Forecast</h2>
    <div id="forecast-container">Loading...</div>
  </section>

  <section class="section">
    <h2>Weather Map</h2>
    <div id="map"></div>
  </section>
</main>

<script>
const API_KEY = '8N4u5YExc2bvNjFNOXUlIQX32ZzOqwUk';  // Your Tomorrow.io API key
const LAT = 40.7128; // Default latitude (NYC)
const LON = -74.0060; // Default longitude (NYC)

// Helper to format timestamp to readable date
function formatDate(ts) {
  const d = new Date(ts * 1000);
  return d.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
}

// Fetch current weather
async function fetchCurrentWeather() {
  const url = `https://api.tomorrow.io/v4/timelines?location=${LAT},${LON}&fields=temperature,humidity,windSpeed,windDirection,uvIndex,visibility,weatherCode&timesteps=current&units=metric&apikey=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();
  if (!data.data) return null;
  return data.data.timelines[0].intervals[0].values;
}

// Fetch minute-by-minute rain forecast (next hour)
async function fetchRainForecast() {
  const url = `https://api.tomorrow.io/v4/timelines?location=${LAT},${LON}&fields=precipitationIntensity&timesteps=1m&units=metric&apikey=${API_KEY}&startTime=now&endTime=nowPlus1h`;
  const res = await fetch(url);
  const data = await res.json();
  if (!data.data) return null;
  return data.data.timelines[0].intervals;
}

// Fetch 3-day daily forecast
async function fetchThreeDayForecast() {
  const url = `https://api.tomorrow.io/v4/timelines?location=${LAT},${LON}&fields=temperatureMax,temperatureMin,precipitationProbability,windSpeed,weatherCode&timesteps=1d&units=metric&apikey=${API_KEY}&startTime=now&endTime=nowPlus3d`;
  const res = await fetch(url);
  const data = await res.json();
  if (!data.data) return null;
  return data.data.timelines[0].intervals;
}

// Fetch alerts
async function fetchAlerts() {
  const url = `https://api.tomorrow.io/v4/alerts?location=${LAT},${LON}&apikey=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();
  return data.data || null;
}

// Weather code descriptions and icons (simplified)
const weatherCodes = {
  1000: {desc: "Clear", icon: "â˜€ï¸"},
  1001: {desc: "Cloudy", icon: "â˜ï¸"},
  1100: {desc: "Mostly Clear", icon: "ğŸŒ¤ï¸"},
  1101: {desc: "Partly Cloudy", icon: "â›…"},
  1102: {desc: "Mostly Cloudy", icon: "ğŸŒ¥ï¸"},
  2000: {desc: "Fog", icon: "ğŸŒ«ï¸"},
  2100: {desc: "Light Fog", icon: "ğŸŒ«ï¸"},
  3000: {desc: "Light Wind", icon: "ğŸŒ¬ï¸"},
  3001: {desc: "Wind", icon: "ğŸ’¨"},
  3002: {desc: "Strong Wind", icon: "ğŸ’¨"},
  4000: {desc: "Drizzle", icon: "ğŸŒ¦ï¸"},
  4001: {desc: "Rain", icon: "ğŸŒ§ï¸"},
  4200: {desc: "Light Rain", icon: "ğŸŒ¦ï¸"},
  4201: {desc: "Heavy Rain", icon: "ğŸŒ§ï¸"},
  5000: {desc: "Snow", icon: "â„ï¸"},
  5001: {desc: "Flurries", icon: "ğŸŒ¨ï¸"},
  5100: {desc: "Light Snow", icon: "ğŸŒ¨ï¸"},
  5101: {desc: "Heavy Snow", icon: "â„ï¸"},
  6000: {desc: "Freezing Drizzle", icon: "ğŸŒ§ï¸"},
  6001: {desc: "Freezing Rain", icon: "ğŸŒ§ï¸"},
  6200: {desc: "Light Freezing Rain", icon: "ğŸŒ§ï¸"},
  6201: {desc: "Heavy Freezing Rain", icon: "ğŸŒ§ï¸"},
  7000: {desc: "Ice Pellets", icon: "ğŸ§Š"},
  7101: {desc: "Heavy Ice Pellets", icon: "ğŸ§Š"},
  7102: {desc: "Light Ice Pellets", icon: "ğŸ§Š"},
  8000: {desc: "Thunderstorm", icon: "â›ˆï¸"},
};

function weatherIcon(code) {
  return weatherCodes[code]?.icon || "â“";
}
function weatherDesc(code) {
  return weatherCodes[code]?.desc || "Unknown";
}

// Show current weather
async function showCurrentWeather() {
  const current = await fetchCurrentWeather();
  if (!current) {
    document.getElementById("current-data").textContent = "Failed to load current weather.";
    return;
  }
  document.getElementById("current-data").innerHTML = `
    <p><strong>Temperature:</strong> ${current.temperature.toFixed(1)} Â°C</p>
    <p><strong>Humidity:</strong> ${current.humidity.toFixed(0)}%</p>
    <p><strong>Wind:</strong> ${current.windSpeed.toFixed(1)} m/s (${current.windDirection.toFixed(0)}Â°)</p>
    <p><strong>UV Index:</strong> ${current.uvIndex.toFixed(1)}</p>
    <p><strong>Visibility:</strong> ${current.visibility.toFixed(1)} km</p>
    <p><strong>Conditions:</strong> ${weatherIcon(current.weatherCode)} ${weatherDesc(current.weatherCode)}</p>
  `;
}

// Show minute-by-minute rain forecast
async function showRainForecast() {
  const intervals = await fetchRainForecast();
  if (!intervals) {
    document.getElementById("rain-data").textContent = "Failed to load rain forecast.";
    return;
  }
  // Build simple bar chart for rain intensity (mm/hr)
  const rainDiv = document.getElementById("rain-data");
  rainDiv.innerHTML = "";

  const maxIntensity = Math.max(...intervals.map(i => i.values.precipitationIntensity));
  intervals.forEach(i => {
    const intensity = i.values.precipitationIntensity;
    const barHeight = maxIntensity ? (intensity / maxIntensity) * 100 : 0;
    const time = new Date(i.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    const bar = document.createElement("div");
    bar.style = `
      display:inline-block;
      width:4px;
      height:${barHeight}px;
      margin-right:1px;
      background: ${intensity > 0 ? '#0077cc' : '#ccc'};
      vertical-align: bottom;
      cursor: help;
    `;
    bar.title = `${time}: ${intensity.toFixed(2)} mm/h`;
    rainDiv.appendChild(bar);
  });
}

// Show 3-day forecast
async function showThreeDayForecast() {
  const days = await fetchThreeDayForecast();
  if (!days) {
    document.getElementById("forecast-container").textContent = "Failed to load forecast.";
    return;
  }
  const container = document.getElementById("forecast-container");
  container.innerHTML = "";
  days.forEach(day => {
    const d = document.createElement("div");
    d.className = "forecast-day";
    const dateStr = formatDate(new Date(day.startTime).getTime() / 1000);
    d.innerHTML = `
      <h3>${dateStr}</h3>
      <p>${weatherIcon(day.values.weatherCode)} ${weatherDesc(day.values.weatherCode)}</p>
      <p><strong>Max:</strong> ${day.values.temperatureMax.toFixed(1)} Â°C</p>
      <p><strong>Min:</strong> ${day.values.temperatureMin.toFixed(1)} Â°C</p>
      <p><strong>Rain chance:</strong> ${day.values.precipitationProbability.toFixed(0)}%</p>
      <p><strong>Wind:</strong> ${day.values.windSpeed.toFixed(1)} m/s</p>
    `;
    container.appendChild(d);
  });
}

// Show alerts if any
async function showAlerts() {
  const alertSection = document.getElementById("alerts-section");
  alertSection.innerHTML = "";
  const alerts = await fetchAlerts();
  if (!alerts || alerts.length === 0) return;

  alerts.forEach(alert => {
    const div = document.createElement("div");
    div.className = "alert";
    div.innerHTML = `<strong>Alert:</strong> ${alert.title}<br>${alert.description || ''}`;
    alertSection.appendChild(div);
  });
}

// Initialize Leaflet map with Tomorrow.io weather layers
function initMap() {
  const map = L.map("map").setView([LAT, LON], 9);
  // Tomorrow.io weather tile layer
  const tileUrl = `https://tile.tomorrow.io/tiles/weather/v1/256/{z}/{x}/{y}.png?apikey=${API_KEY}`;
  L.tileLayer(tileUrl, {
    attribution: 'Â© Tomorrow.io',
    maxZoom: 12,
    minZoom: 5,
  }).addTo(map);
  return map;
}

async function init() {
  await showAlerts();
  await showCurrentWeather();
  await showRainForecast();
  await showThreeDayForecast();
  initMap();
}

init();
</script>
</body>
</html>
